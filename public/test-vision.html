<!DOCTYPE html>
<html>

<head>
    <title>OCR Test Lab - Google Vision</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .col {
            flex: 1;
        }

        img,
        canvas {
            border: 1px solid #444;
            max-width: 100%;
        }

        .box {
            background: #333;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        h3 {
            margin-top: 0;
            color: #fbbf24;
        }

        .success {
            color: #4ade80;
        }

        .fail {
            color: #f87171;
        }

        pre {
            background: black;
            padding: 10px;
            overflow: auto;
        }

        .status {
            padding: 10px;
            background: #444;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>ðŸ§ª OCR Test Lab - Google Cloud Vision API</h1>
    <p>Testing with provided image: <code>test-card.png</code></p>
    <div class="status" id="status">Loading...</div>

    <div class="container">
        <div class="col">
            <div class="box">
                <h3>1. Original Input</h3>
                <img id="source" src="/test-card.png" crossorigin="anonymous" onload="runTest()" />
            </div>
        </div>
        <div class="col">
            <div class="box">
                <h3>2. Name ROI</h3>
                <canvas id="nameCanvas"></canvas>
                <div id="nameResult">Waiting...</div>
            </div>
            <div class="box">
                <h3>3. DOB ROI</h3>
                <canvas id="dobCanvas"></canvas>
                <div id="dobResult">Waiting...</div>
            </div>
        </div>
    </div>

    <script>
        async function runTest() {
            const img = document.getElementById('source');
            const CARD_WIDTH = 1024;
            const CARD_HEIGHT = 640;

            document.getElementById('status').innerText = 'Processing image...';

            // Normalize image size
            const mainCanvas = document.createElement('canvas');
            mainCanvas.width = CARD_WIDTH;
            mainCanvas.height = CARD_HEIGHT;
            const ctx = mainCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0, CARD_WIDTH, CARD_HEIGHT);

            // ROI Calculation - matching imageProcessing.ts
            const nameX = Math.floor(0.05 * CARD_WIDTH);
            const nameY = Math.floor(0.19 * CARD_HEIGHT);
            const nameW = Math.floor(0.35 * CARD_WIDTH);
            const nameH = Math.floor(0.06 * CARD_HEIGHT);

            const dobX = Math.floor(0.52 * CARD_WIDTH);
            const dobY = Math.floor(0.525 * CARD_HEIGHT);
            const dobW = Math.floor(0.175 * CARD_WIDTH);
            const dobH = Math.floor(0.055 * CARD_HEIGHT);

            document.getElementById('status').innerText = 'Extracting ROIs...';

            // Process Name
            await processROI('nameCanvas', 'nameResult', mainCanvas, nameX, nameY, nameW, nameH, 'Name');

            // Process DOB
            await processROI('dobCanvas', 'dobResult', mainCanvas, dobX, dobY, dobW, dobH, 'DOB');

            document.getElementById('status').innerText = 'âœ… Complete!';
        }

        async function processROI(canvasId, resultId, sourceCanvas, x, y, w, h, label) {
            const canvas = document.getElementById(canvasId);
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');

            // 1. Draw original crop
            ctx.drawImage(sourceCanvas, x, y, w, h, 0, 0, w, h);

            // 2. Apply Binarization
            const imageData = ctx.getImageData(0, 0, w, h);
            const data = imageData.data;
            const threshold = 140;

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                const val = gray < threshold ? 0 : 255;
                data[i] = val;
                data[i + 1] = val;
                data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);

            // 3. Upscale 2x
            const scale = 2;
            const upscaled = document.createElement('canvas');
            upscaled.width = w * scale;
            upscaled.height = h * scale;
            const upCtx = upscaled.getContext('2d');
            upCtx.imageSmoothingEnabled = false;
            upCtx.drawImage(canvas, 0, 0, upscaled.width, upscaled.height);

            // Update display canvas
            canvas.width = upscaled.width;
            canvas.height = upscaled.height;
            canvas.getContext('2d').drawImage(upscaled, 0, 0);

            // 4. Run OCR via API
            document.getElementById(resultId).innerHTML = `<div style="color: #fbbf24;">Running Google Vision API for ${label}...</div>`;

            try {
                const imageDataUrl = upscaled.toDataURL('image/png');

                const response = await fetch('/api/ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageDataUrl })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API request failed');
                }

                const result = await response.json();
                const text = result.text || '';
                const conf = result.confidence.toFixed(1);

                const color = conf > 70 ? '#4ade80' : conf > 40 ? '#fbbf24' : '#f87171';

                document.getElementById(resultId).innerHTML = `
                    <div style="font-size: 24px; font-weight: bold; color: ${color};">"${text}"</div>
                    <div>Confidence: ${conf}%</div>
                `;
            } catch (e) {
                document.getElementById(resultId).innerHTML = `<div style="color: #f87171;">Error: ${e.message}</div>`;
            }
        }
    </script>
</body>

</html>